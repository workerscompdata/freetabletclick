---
import IconX from "@/assets/icons/IconX.svg";
import IconMoon from "@/assets/icons/IconMoon.svg";
import IconSunHigh from "@/assets/icons/IconSunHigh.svg";
import IconMenuDeep from "@/assets/icons/IconMenuDeep.svg";
import { SITE } from "@/config";

const { pathname } = Astro.url;

// Remove trailing slash from current pathname if exists
const currentPath =
  pathname.endsWith("/") && pathname !== "/" ? pathname.slice(0, -1) : pathname;

const isActive = (path: string) => {
  const currentPathArray = currentPath.split("/").filter(p => p.trim());
  const pathArray = path.split("/").filter(p => p.trim());

  if (path === "/" && currentPath === "/") return true;
  if (path !== "/" && currentPathArray[0] === pathArray[0]) return true;
  return false;
};
---

<a
  id="skip-to-content"
  href="#main-content"
  class="absolute start-16 -top-full z-[60] bg-primary-light px-4 py-3 text-white font-bold backdrop-blur-lg transition-all focus:top-4 rounded-b-xl shadow-xl"
>
  Skip to content
</a>

<header class="sticky top-0 z-50 w-full bg-background/80 backdrop-blur-md border-b border-border shadow-sm transition-all duration-300">
  <div class="mx-auto flex h-20 max-w-7xl items-center justify-between px-4 sm:px-6 lg:px-8">
    
    <!-- Logo / Branding -->
    <a href="/" class="flex items-center gap-2.5 group focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary-light rounded-lg">
      <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-blue-600 text-white shadow-md group-hover:scale-105 transition-transform duration-300">
        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
      </div>
      <span class="text-xl sm:text-2xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-blue-700 to-blue-400 dark:from-blue-400 dark:to-blue-200">
        FreeTablet.click
      </span>
    </a>

    <!-- Desktop Navigation -->
    <nav class="hidden lg:flex items-center gap-8 h-full" aria-label="Main Navigation">
      <a href="/" class={`text-sm font-semibold transition-colors hover:text-primary-light ${isActive("/") ? "text-primary-light" : "text-foreground/80"}`}>Home</a>
      <a href="/how-to-apply" class={`text-sm font-semibold transition-colors hover:text-primary-light ${isActive("/how-to-apply") ? "text-primary-light" : "text-foreground/80"}`}>How to Apply</a>
      <a href="/eligibility" class={`text-sm font-semibold transition-colors hover:text-primary-light ${isActive("/eligibility") ? "text-primary-light" : "text-foreground/80"}`}>Eligibility</a>
      <a href="/states" class={`text-sm font-semibold transition-colors hover:text-primary-light ${isActive("/states") ? "text-primary-light" : "text-foreground/80"}`}>States</a>
      
      <!-- Providers Dropdown (CSS Only) -->
      <div class="group relative flex h-full items-center">
        <button class="flex items-center gap-1 text-sm font-semibold text-foreground/80 hover:text-primary-light transition-colors focus-visible:outline-none">
          Providers
          <svg class="w-4 h-4 transition-transform duration-200 group-hover:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
        </button>
        <!-- Dropdown Menu -->
        <div class="absolute left-1/2 top-[70px] -translate-x-1/2 w-56 invisible opacity-0 translate-y-2 group-hover:visible group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-300 z-50">
          <div class="bg-background border border-border shadow-xl rounded-2xl p-2 flex flex-col gap-1 relative before:absolute before:-top-2 before:left-1/2 before:-translate-x-1/2 before:border-8 before:border-transparent before:border-b-background">
            <a href="/airtalk-wireless" class="px-4 py-2.5 rounded-xl hover:bg-blue-50 dark:hover:bg-muted/50 text-sm font-bold text-foreground/80 hover:text-primary-light transition-colors">AirTalk Wireless</a>
            <a href="/assurance-wireless" class="px-4 py-2.5 rounded-xl hover:bg-blue-50 dark:hover:bg-muted/50 text-sm font-bold text-foreground/80 hover:text-primary-light transition-colors">Assurance Wireless</a>
            <a href="/safelink-wireless" class="px-4 py-2.5 rounded-xl hover:bg-blue-50 dark:hover:bg-muted/50 text-sm font-bold text-foreground/80 hover:text-primary-light transition-colors">SafeLink Wireless</a>
            <a href="/standup-wireless" class="px-4 py-2.5 rounded-xl hover:bg-blue-50 dark:hover:bg-muted/50 text-sm font-bold text-foreground/80 hover:text-primary-light transition-colors">StandUp Wireless</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Right Side Actions -->
    <div class="flex items-center gap-3 sm:gap-4">
      
      <!-- Primary CTA (Hidden on tiny mobile, shows on sm and up) -->
      <a href="/how-to-apply" class="hidden sm:inline-flex items-center justify-center rounded-lg bg-blue-600 px-5 py-2.5 text-sm font-bold text-white shadow-md hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 transition-all duration-200">
        Apply Now
      </a>

      <!-- Theme Toggle -->
      {
        SITE.lightAndDarkMode && (
          <button
            id="theme-btn"
            class="focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary-light relative flex items-center justify-center w-10 h-10 rounded-full hover:bg-muted/50 transition-colors text-foreground/80 hover:text-primary-light"
            title="Toggles light & dark"
            aria-label="Toggle Theme"
          >
            <IconMoon class="absolute scale-100 rotate-0 transition-all dark:scale-0 dark:-rotate-90 w-5 h-5" />
            <IconSunHigh class="absolute scale-0 rotate-90 transition-all dark:scale-100 dark:rotate-0 w-5 h-5" />
          </button>
        )
      }

      <!-- Mobile Menu Hamburger -->
      <button
        id="menu-btn"
        class="lg:hidden flex items-center justify-center w-10 h-10 rounded-full hover:bg-muted/50 transition-colors text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary-light"
        aria-label="Toggle Menu"
        aria-expanded="false"
        aria-controls="menu-items"
      >
        <IconMenuDeep id="menu-icon" class="w-6 h-6" />
        <IconX id="close-icon" class="hidden w-6 h-6" />
      </button>
      
    </div>
  </div>

  <!-- Mobile Navigation Dropdown -->
  <nav
    id="menu-items"
    class="hidden lg:hidden absolute top-20 left-0 w-full bg-background border-b border-border shadow-2xl px-4 py-6"
  >
    <ul class="flex flex-col gap-2">
      <li><a href="/" class={`block px-4 py-3 rounded-xl text-base font-bold transition-colors ${isActive("/") ? "bg-blue-50 text-primary-light dark:bg-muted/50" : "hover:bg-muted text-foreground/80"}`}>Home</a></li>
      <li><a href="/how-to-apply" class={`block px-4 py-3 rounded-xl text-base font-bold transition-colors ${isActive("/how-to-apply") ? "bg-blue-50 text-primary-light dark:bg-muted/50" : "hover:bg-muted text-foreground/80"}`}>How to Apply</a></li>
      <li><a href="/eligibility" class={`block px-4 py-3 rounded-xl text-base font-bold transition-colors ${isActive("/eligibility") ? "bg-blue-50 text-primary-light dark:bg-muted/50" : "hover:bg-muted text-foreground/80"}`}>Eligibility</a></li>
      <li><a href="/states" class={`block px-4 py-3 rounded-xl text-base font-bold transition-colors ${isActive("/states") ? "bg-blue-50 text-primary-light dark:bg-muted/50" : "hover:bg-muted text-foreground/80"}`}>State Directory</a></li>
      
      <!-- Mobile Providers Section -->
      <li class="pt-4 pb-2">
        <span class="px-4 text-xs font-extrabold text-foreground/50 uppercase tracking-wider">Top Providers</span>
        <ul class="flex flex-col gap-1 mt-2 border-l-2 border-border ml-6 pl-2">
          <li><a href="/airtalk-wireless" class="block px-4 py-2 rounded-lg hover:bg-muted text-sm font-bold text-foreground/80 hover:text-primary-light">AirTalk Wireless</a></li>
          <li><a href="/assurance-wireless" class="block px-4 py-2 rounded-lg hover:bg-muted text-sm font-bold text-foreground/80 hover:text-primary-light">Assurance Wireless</a></li>
          <li><a href="/safelink-wireless" class="block px-4 py-2 rounded-lg hover:bg-muted text-sm font-bold text-foreground/80 hover:text-primary-light">SafeLink Wireless</a></li>
          <li><a href="/standup-wireless" class="block px-4 py-2 rounded-lg hover:bg-muted text-sm font-bold text-foreground/80 hover:text-primary-light">StandUp Wireless</a></li>
        </ul>
      </li>

      <li class="mt-6 sm:hidden">
        <a href="/how-to-apply" class="flex w-full items-center justify-center rounded-xl bg-blue-600 px-5 py-4 text-base font-bold text-white shadow-md hover:bg-blue-500 transition-colors">
          Apply Now
        </a>
      </li>
    </ul>
  </nav>
</header>

<script>
  function toggleNav() {
    const menuBtn = document.querySelector("#menu-btn");
    const menuItems = document.querySelector("#menu-items");
    const menuIcon = document.querySelector("#menu-icon");
    const closeIcon = document.querySelector("#close-icon");

    if (!menuBtn || !menuItems || !menuIcon || !closeIcon) return;

    menuBtn.addEventListener("click", () => {
      const openMenu = menuBtn.getAttribute("aria-expanded") === "true";

      menuBtn.setAttribute("aria-expanded", openMenu ? "false" : "true");
      menuBtn.setAttribute("aria-label", openMenu ? "Open Menu" : "Close Menu");

      menuItems.classList.toggle("hidden");
      menuIcon.classList.toggle("hidden");
      closeIcon.classList.toggle("hidden");
    });
  }

  toggleNav();

  // Runs on view transitions navigation
  document.addEventListener("astro:after-swap", toggleNav);
</script>